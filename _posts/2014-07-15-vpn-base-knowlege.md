---
layout: post
title: VPN详解
category: Openwrt
---

公司的wifi设备需要搭建VPN功能，在了解Openwrt的过程中，对VPN相关的基础知识进行了一下梳理。

VPN 即"Virtual Private Network",虚拟专用网络，为我们提供了一种通过公用网络安全的访问公司内网的方式，网络都是由客户机，传输介质，服务端连接成的，VPN也一样，不同的VPN连接方式使用的是隧道的传输通道，这个隧道是建立在公用网络或专用网络基础之上的；

### VPN网络的实现

要实现vpn网络，企业内部要由一个vpn服务器，一边连接内部的专有网络，另外连接互联网，也就是有一个公有的IP地址，当客户机通过vpn服务器对专用网络的计算机进行通信时候，isp现将内容发送至vpn服务器，然后再由服务器将数据发送至目标计算机，为了这个过程安全，vpn使用三个特性保证通信的安全性：隧道协议，身份验证和数据加密；客户机向vpn服务器发送请求，服务器接受响应并向客户机发送身份验证，客户机将加密的信息响应给服务器，服务器根据用户数据库接受响应，如果账户有效，则根据用户数据库确定客户机是否有远程访问权限，如果用户有访问权限，在身份验证中得过程中产生的公钥对数据进行加密；

### VPN网络的分类

* 各企业部门与其他远程分支间的Intranet VPN；
* 企业网与远程员工之间的Remote VPN；
* 企业与合作伙伴客户之间的Extranet VPN；

### VPN网络的要求与协议

VPN的要求：__安全性，性能__，VPN能够让管理员进行通信的控制来确保性能，管理问题，互操作问题：在Extranet VPN中，企业要与不同的供应商建立联系，不同的VPN解决方案就会产生，企业的VPN产品应该与其他的进行互操作，要求所有的VPN协议都是要遵循工业标准的，这些协议有，__IPsec，点到点的隧道协议(point to point tunneling protocal), 第二层隧道协议(layer 2 Tunneling protocal)；__

VPN使用的协议：隧道协议，简单讲就是在网络的a端报文进行封装，到达目的地b端之后解除封装恢复报文，这样就形成了一条隧道，目前的有一般路由封装(general routing, Encapsulation)，pptp , l2tp；VPN使用后两种协议；GRE技术是用在路由中得，可以满足intranet与extranet之间的需求，但是在远程访问的vpn中，使用的大部分都是拨号，所以使用pptp l2tp的比较多；

L2TP作为隧道协议中的NAS强制模型在网络中同另外一端的点建立连接的重要协议，建立连接的过程如下：
1.通过modem对nas建立连接；
2.用户通过nas的l2tp连接服务器进行身份验证；
3.在政策配置文件或者NAS与政策服务器进行协商的基础之上，NAS和l2tp接入服务器建立一条L2TP隧道；
4.用户与l2tp接入服务器建立一个点到点协议的连接，访问隧道服务；
5.用户通过该隧道获得VPN服务。


PPTP作为主动隧道模型允许终端系统进行配置，与远程的PPTP服务器之间建立一条点对点的，不连续的隧道，并且这个过程没有中间媒介NAS的介入，NAS只提供网络服务，建立连接的过程：
1.用户通过串口以IP拨号的方式与提供网络服务的nas连接；
2.用户通过路由信息定位PPTP接入服务器；
3.用户形成一个PPTP的虚拟接口；
4.用户通过该接口与PPTP接入服务器进行协商，建立一条ppp访问服务隧道；
5.用户通过该隧道获得VPN服务。


在L2TP中，用户感觉不到NAS的存在，仿佛与PPTP接入服务器直接进行连接；PPTP相对于NAS相对是透明的，NAS并不知道PPTP的存在，只是简单的把PPTP流量当做普通IP流量进行处理，采用哪种协议主要是在于要把控制权放到nas手中还是用户手中，L2TP比pptp安全，因为它能知道用户是从哪里来的，L2TP比较适合用于集中的固定的VPN用户，而PPTP适合用于移动的用户；

对于PPTP服务器，将采用MPPE加密技术 MPPE可以支持40位密钥的标准加密方案和128位密钥的增强加密方案。对于L2TP服务器，将使用IPSec机制对数据进行加密 IPSec是基于密码学的保护服务和安全协议的套件。

### VPN建立的步骤，加密验证

VPN建立的步骤：
1.VPN设备接收需要发送的数据；
2.VPN设备像目标机器发送连接请求，双方交换秘钥，并通过加密验证双方的身份，这是IKE1阶段；
3.如果IKE1阶段完成，则交换双方秘钥并且协商数据加密算法，这是IKE2；
4.如果IKE2完成，则VPN隧道建立，数据可以加密传输；
5.根据指令关闭隧道，并且关闭连接；

VPN有两层加密验证，一层是建立二层隧道的时候，进行了交换秘钥，一层是商定加密算法的时候，交换了秘钥，以协商使用何种加密算法。VPN能否成功建立，关键在IKE 1 2 阶段，即是INTERNET KEY EXCHANGE。

当移动用户或者远程用户通过拨号方式访问公司内部网络的时候，用以往的资费会比较昂贵，而且安全性不能保证，为了避免这个问题，通过拨号与企业内部网络进行VPN连接是一个不错的选择。

### VPN的好处

1.消费低，省成本，用户可以从本地ISP服务商申请internet访问，然后通过Internet隧道与企业内部进行连接，节省了大量的通信成本；
2.增强网络的安全性；
3.网络协议支持，支持最常用的网络协议，客户机很容易的支持VPN；
4.IP地址安全，VPN在internet中传输，internet的用户上看到的都是公网的IP；


